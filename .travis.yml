
services:
  - docker
before_install:
  - echo $DOCKER_PASSWORD | docker login --username $DOCKER_LOGIN --password-stdin
  - docker login --username=_ --password=$(heroku auth:token) registry.heroku.com

install:
  # Script for Building Docker Image for Tests
  - docker build --cache-from todo_app:test --target test --tag todo_app:test --tag todo_app:test_e2e .
  #- docker build --target test --tag todo_app:test_e2e .
  - docker build --cache-from $DOCKER_LOGIN/todo_app:latest --target production --tag $DOCKER_LOGIN/todo_app:latest .
  - docker push $DOCKER_LOGIN/todo_app:latest
  - docker tag $DOCKER_LOGIN/todo_app registry.heroku.com/$HEROKU_APP/web
  - docker push registry.heroku.com/$HEROKU_APP/web
  
script:
  # Script for running Tests on CI
  - docker run todo_app:test tests
  #- docker run --env-file .env todo_app:test tests_e2e
  - docker run --env API_KEY --env API_TOKEN --env NAME --env BOARD_ID --env TODO_LIST_ID --env DOING_LIST_ID --env DONE_LIST_ID --env FLASK_APP --env FLASK_ENV  todo_app:test tests_e2e
  # End of Script 
deploy:
  provider: script
  api_key: $HEROKU_API_KEY
  script:
    - heroku container:release -a $HEROKU_APP web
  on: 
    branch: Module_8





